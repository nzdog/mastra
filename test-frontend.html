<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Field Diagnostic Protocol - Test</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      padding: 20px;
      line-height: 1.6;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    h1 {
      color: #fff;
      margin-bottom: 10px;
    }
    .info {
      background: #1a1a1a;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 3px solid #4CAF50;
    }
    .output {
      background: #1a1a1a;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      min-height: 200px;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }
    .supports {
      background: #252525;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .support-item {
      margin-bottom: 10px;
      padding: 10px;
      background: #1a1a1a;
      border-radius: 4px;
    }
    .support-item strong {
      color: #4CAF50;
    }
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    input {
      flex: 1;
      padding: 12px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #fff;
      font-size: 14px;
    }
    button {
      padding: 12px 24px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    .error {
      background: #ff4444;
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .session-info {
      font-size: 12px;
      color: #888;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üåø Field Diagnostic Protocol - API Test</h1>

    <div class="info">
      <strong>Backend:</strong> http://localhost:3000<br>
      <strong>Status:</strong> <span id="status">Checking...</span>
    </div>

    <div class="session-info" id="sessionInfo">
      No active session
    </div>

    <div class="controls">
      <input
        type="text"
        id="userInput"
        placeholder="Type your message here..."
        onkeypress="if(event.key === 'Enter') sendMessage()"
      >
      <button onclick="sendMessage()" id="sendBtn">Send</button>
      <button onclick="resetSession()">Reset</button>
    </div>

    <div id="error" class="error" style="display: none;"></div>

    <div class="output" id="output">
      Welcome! Type something to start the protocol...
    </div>

    <div class="supports" id="supports" style="display: none;">
      <strong>üìö Protocol Supports:</strong>
      <div id="supportsList"></div>
    </div>
  </div>

  <script>
    let sessionId = null;
    let currentState = null;

    // Check health on load
    checkHealth();

    async function checkHealth() {
      try {
        const res = await fetch('http://localhost:3000/health');
        const data = await res.json();
        document.getElementById('status').textContent = `‚úÖ Online (${data.active_sessions} active sessions)`;
        document.getElementById('status').style.color = '#4CAF50';
      } catch (error) {
        document.getElementById('status').textContent = '‚ùå Offline';
        document.getElementById('status').style.color = '#ff4444';
      }
    }

    async function sendMessage() {
      const input = document.getElementById('userInput');
      const message = input.value.trim();
      if (!message) return;

      const sendBtn = document.getElementById('sendBtn');
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';

      try {
        let response;

        if (!sessionId) {
          // Start new session
          response = await fetch('http://localhost:3000/api/walk/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_input: message })
          });
        } else {
          // Continue existing session
          response = await fetch('http://localhost:3000/api/walk/continue', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              session_id: sessionId,
              user_response: message
            })
          });
        }

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Request failed');
        }

        const data = await response.json();

        // Update session
        if (!sessionId) {
          sessionId = data.session_id;
        }
        currentState = data.state;

        // Update UI
        updateSessionInfo(data);
        displayOutput(data.composer_output);
        displaySupports(data.supports);
        hideError();

        // Clear input
        input.value = '';

      } catch (error) {
        showError(error.message);
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
      }
    }

    function updateSessionInfo(data) {
      const info = document.getElementById('sessionInfo');
      info.innerHTML = `
        <strong>Session:</strong> ${data.session_id.substring(0, 8)}...<br>
        <strong>Mode:</strong> ${data.mode} |
        <strong>Theme:</strong> ${data.theme_number}/${data.total_themes} |
        <strong>Turn:</strong> ${data.state.turn_count}
      `;
    }

    function displayOutput(markdown) {
      const output = document.getElementById('output');
      // Simple markdown rendering
      let html = markdown
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
      output.innerHTML = html;
    }

    function displaySupports(supports) {
      const supportsDiv = document.getElementById('supports');
      const supportsList = document.getElementById('supportsList');

      if (!supports || supports.length === 0) {
        supportsDiv.style.display = 'none';
        return;
      }

      supportsDiv.style.display = 'block';
      supportsList.innerHTML = supports.map(s => `
        <div class="support-item">
          <strong>${s.theme}</strong><br>
          <em style="color: #aaa;">${s.excerpt}</em>
        </div>
      `).join('');
    }

    function showError(message) {
      const error = document.getElementById('error');
      error.textContent = '‚ùå Error: ' + message;
      error.style.display = 'block';
    }

    function hideError() {
      document.getElementById('error').style.display = 'none';
    }

    function resetSession() {
      sessionId = null;
      currentState = null;
      document.getElementById('output').textContent = 'Session reset. Type something to start fresh...';
      document.getElementById('supports').style.display = 'none';
      document.getElementById('sessionInfo').textContent = 'No active session';
      hideError();
    }
  </script>
</body>
</html>
