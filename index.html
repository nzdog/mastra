<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lichen Field</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- CSS Stylesheets -->
    <link rel="stylesheet" href="/assets/css/base.css" />
    <link rel="stylesheet" href="/assets/css/animations.css" />
    <link rel="stylesheet" href="/assets/css/layout.css" />
    <link rel="stylesheet" href="/assets/css/components.css" />
    <link rel="stylesheet" href="/assets/css/views.css" />
    <link rel="stylesheet" href="/assets/css/responsive.css" />
  </head>
  <body>
    <!-- Page Header -->
    <div class="page-header intro-mode" id="page-header">
      <div class="header-title">Lichen</div>
      <img src="/lichen-logo.png" alt="" class="header-center-logo" id="header-center-logo" />
      <div class="header-logo-badge" id="memory-layer-badge" data-dev-badge>Memory Layer Dev</div>
      <div class="header-state" id="header-state">Entry</div>
      <div class="theme-position" id="theme-position"></div>
      <div class="cost-display" id="cost-display">$0.00</div>
      <div class="branch-label" id="branch-label">loading...</div>
    </div>

    <!-- State Header (legacy - for walk mode) -->
    <div class="state-header" id="state-header" style="display: none">
      <div class="mode-indicator" id="mode-indicator">Entry</div>
      <div class="protocol-name" id="protocol-name"></div>
    </div>

    <!-- Screen reader announcements -->
    <div
      class="sr-only"
      role="status"
      aria-live="polite"
      aria-atomic="true"
      id="sr-announcer"
    ></div>

    <!-- Intro Flow View -->
    <div class="intro-flow-view" id="intro-flow-view">
      <!-- Spinning Logo -->
      <div class="intro-logo-container">
        <img src="/lichen-logo.png" alt="Lichen" class="logo-spin-intro" id="intro-logo" />
        <div class="header-logo-badge" style="transform: translate(-10px, 36px)" data-dev-badge>
          Memory Layer Dev
        </div>
      </div>

      <div class="intro-content" id="intro-content">
        <!-- Quote - Desktop Version -->
        <div class="intro-quote desktop-only" id="intro-quote-desktop">
          "The field is the sole governing agency of the particle."
        </div>

        <!-- Quote - Mobile Version (Inline Attribution) -->
        <div class="intro-quote mobile-only" id="intro-quote-mobile">
          "The field is the sole governing agency of the particle." — Albert Einstein
        </div>

        <!-- Embodiment Lines -->
        <div id="intro-embodiment-lines"></div>

        <!-- Orientation (hidden) -->
        <div class="intro-orientation" id="intro-orientation" style="display: none">
          Orientation with the system is six protocols long
        </div>

        <!-- Continue Button (shown after orientation) -->
        <div class="intro-continue-container" id="intro-continue-container">
          <button class="intro-continue-btn" id="intro-continue-btn">Continue</button>
          <div class="intro-continue-hint">Press Shift + Enter or ⌘/Ctrl + Enter</div>
        </div>
      </div>

      <!-- Protocol List Page (shown after Continue) -->
      <div class="intro-protocol-list-page" id="intro-protocol-list-page">
        <!-- Protocol Guidance -->
        <div class="intro-protocol-guidance" id="intro-protocol-guidance">
          <p>
            The Field Exit Protocols are meant to be walked in order, as each one supports the
            next—from identifying the field you're in, to releasing its residue, closing it with
            integrity, and learning to hold a new one. Following the full sequence provides the most
            complete process of change.
          </p>
          <p>
            However, the protocols can also be used individually. You can read the "Use this when…"
            section and begin with whichever one feels most relevant. What matters is that you
            engage honestly with the process, in whatever order makes sense for you.
          </p>
        </div>

        <!-- Sequence List -->
        <div class="intro-sequence-container" id="intro-sequence-container">
          <ul class="intro-sequence-list">
            <li class="intro-sequence-item prelude">Field Diagnostic (prelude)</li>
            <li class="intro-sequence-item" data-number="1.">Knowing When a Field Must End</li>
            <li class="intro-sequence-item" data-number="2.">Composting the Old Signal</li>
            <li class="intro-sequence-item" data-number="3.">
              Extracting the Gifts Without Carrying the Pattern
            </li>
            <li class="intro-sequence-item" data-number="4.">Designing a Clean Exit</li>
            <li class="intro-sequence-item" data-number="5.">Walking Forward Without Residue</li>
          </ul>
          <div class="intro-sequence-subtext">
            Each stage opens the next. You will be guided, one step at a time.
          </div>
        </div>

        <!-- Protocol Deck -->
        <div class="intro-protocol-deck" id="intro-protocol-deck">
          <!-- Protocol cards will be populated by JavaScript -->
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="content-area">
      <div class="field-container" id="main-content">
        <!-- Protocol Selection View -->
        <div class="protocol-selection-view hidden" id="protocol-selection-view">
          <div class="protocol-selection-header">
            <img
              src="/lichen-logo.png"
              alt="Lichen"
              style="height: 80px; width: auto; margin-bottom: 2rem"
            />
            <div
              class="header-logo-badge"
              style="transform: translate(60px, -40px); font-size: 0.95rem"
              data-dev-badge
            >
              Memory Layer Dev
            </div>
            <div class="protocol-selection-title">Choose Your Protocol</div>
            <div class="protocol-selection-subtitle">Select a protocol to begin your walk</div>
          </div>
          <div class="protocol-grid" id="protocol-grid">
            <!-- Protocol cards will be populated by JavaScript -->
          </div>
        </div>

        <!-- Entry View -->
        <div class="entry-view hidden" id="entry-view">
          <img
            src="/lichen-logo.png"
            alt="Lichen"
            id="lichen-logo"
            style="height: 80px; width: auto; margin-bottom: 2rem"
          />
          <div
            class="header-logo-badge"
            style="transform: translate(60px, -40px); font-size: 0.95rem"
            data-dev-badge
          >
            Memory Layer Dev
          </div>

          <script>
            // Show Memory Layer Dev badges only when explicitly requested.
            (function () {
              try {
                const urlParams = new URLSearchParams(window.location.search);
                const devParam = urlParams.get('dev');
                const localFlag = localStorage.getItem('showMemoryLayerBadge');
                const shouldShow = devParam === 'memory-layer' || localFlag === 'true';

                document.querySelectorAll('[data-dev-badge]').forEach((el) => {
                  if (el && el.style) el.style.display = shouldShow ? 'block' : 'none';
                });
              } catch (e) {
                // Fail silently
              }
            })();
          </script>
          <div
            id="protocol-title"
            style="
              font-size: 1.5rem;
              font-weight: 500;
              color: #78716c;
              margin-bottom: 3rem;
              text-align: center;
              line-height: 1.4;
              cursor: pointer;
              transition: color 0.2s ease;
            "
            title="Click to expand all sections"
          >
            Field Diagnostic Protocol
          </div>
          <button class="walk-button" id="begin-button">Begin walk</button>
        </div>

        <!-- Walk View (hidden initially) -->
        <div id="walk-view" style="display: none; transition: opacity 0.8s ease-out">
          <!-- Error Strip -->
          <div class="error-strip" id="error-strip">
            <div class="error-message" id="error-message"></div>
          </div>

          <!-- Composer Output -->
          <div class="composer-output" id="composer-output"></div>

          <!-- Response Area -->
          <div class="response-area">
            <textarea
              class="response-input"
              id="response-input"
              placeholder="Your response..."
              rows="3"
            ></textarea>
            <div class="response-hint" id="response-hint"></div>

            <div class="walk-control" id="walk-control">
              <button
                class="walk-button"
                id="continue-button"
                disabled
                aria-label="Continue (Ctrl or Cmd + Enter)"
              >
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  style="display: block; margin: 0 auto"
                >
                  <polyline points="18 15 12 9 6 15"></polyline>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Supports Strip - DISABLED -->
    <!-- <div class="supports-strip" id="supports-strip">
        <div class="supports-container" id="supports-container"></div>
    </div> -->

    <!-- Completion Overlay -->
    <div class="completion-overlay" id="completion-overlay">
      <div class="completion-message">
        <div class="completion-title" id="overlay-title">Protocol complete.</div>
        <div class="completion-subtitle" id="overlay-subtitle">The field rests.</div>
      </div>
    </div>

    <!-- Main Application Module -->
    <script type="module" src="/assets/js/app.js"></script>

    <!-- Legacy inline script removed - now using modular JavaScript in assets/js/ -->
  </body>
</html>
